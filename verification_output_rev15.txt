--- SETUP DB ---
Creating/Fetching User...
Create User Note: A user with this email address has already been registered
User ID: 8dabe9a6-a181-418c-b1e2-74026df2fecf

--- TEST 1: CUSTOMER BINDING (MISMATCH) ---
Calling Join Queue with Mismatched SI (Customers: cus_TmcVBaJii22qDf vs cus_TmcVPBkDoW4sjQ )...
Response Status: 400
Response Body: {"error":"SetupIntent customer mismatch"}
✅ PASS: Mismatch Rejected

--- TEST 2: IDEMPOTENCY ---
Inserting Queue Row with PM: pm_1Sp3GZQ6skL3QrtsVKEYyJ8T
Running Process 1...
Row 1 Status: active PI: pi_3Sp3GcQ6skL3Qrts1lyftb6P
Resetting to pending_ready (Attempt 0)...
Running Process 2 (Retry)...
Row 2 Status: active PI: pi_3Sp3GcQ6skL3Qrts1lyftb6P
✅ PASS: Idempotency Key Worked (Same PI ID returned)
Stripe PI Amount: 4900

--- TEST 3: COMPLETE PAYMENT (SCA) ---
Calling complete-payment as Owner...
Response: {
  client_secret: "pi_3Sp3GcQ6skL3Qrts1lyftb6P_secret_QTNEcK90OpcwlEvyjVg4lXxCo"
}
✅ PASS: Verification successful, client_secret returned

--- TEST 4: POLLER RECONCILIATION (Requires Action -> Active) ---
Debug: Pre-Poller Peek Count: 1
Debug: Row is VISIBLE for claiming.
Running Poller (expecting reconciliation to Active)...
Poller Response Status: 200
Poller Response Body: {"success":true,"results":[],"logs":["Reconcile Tasks Found: 1","Processing Task: 136 PI: pi_3Sp3GcQ6skL3Qrts1lyftb6P","Stripe Status: succeeded -> DB Status: active","Notification Gate: true"]}
Poller Result Status: active
Poller Result Notified: active
✅ PASS: Poller correctly finalized and gated notification

--- TEST 5: ATOMIC NOTIFICATION GATE ---
Run 1 (Already Active): false
Run 2 (Reset -> Active): true
Run 3 (Repeat): false
✅ PASS: Atomic Gate enforced correctly
